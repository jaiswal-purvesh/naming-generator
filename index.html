import React, { useMemo, useState } from "react";

// Single-file React app that generates compliant resource names for cloud/network components
// Fits the naming pattern: org-workload-env-region-resourcetype-tier?-component?-seq?
// Tailwind is available in canvas. No external UI libs required.

const ENV_OPTIONS = ["dev", "tst", "stg", "prd"];
const TIER_OPTIONS = ["", "web", "app", "db", "mgmt", "shared"];
const PROVIDERS = ["azure", "aws", "gcp"];

const RESOURCE_TYPES = {
  azure: [
    "vnet",
    "snet",
    "nsg",
    "rt",
    "pip",
    "natgw",
    "vpngw",
    "agw",
    "lb",
    "afw",
    "pep",
    "peer",
  ],
  aws: [
    "vpc",
    "subnet",
    "sg",
    "rtb",
    "igw",
    "natgw",
    "tgw",
    "vpce",
    "alb",
    "nlb",
    "nacl",
    "pcx",
    "cgw",
    "vpngw",
  ],
  gcp: ["vpc", "snet", "fwr", "cr", "nat", "eip", "lb", "peer"],
};

const REGION_HINTS = {
  azure: [
    { name: "centralindia", code: "cin" },
    { name: "eastus2", code: "eus2" },
    { name: "westeurope", code: "weu" },
    { name: "southeastasia", code: "sea" },
  ],
  aws: [
    { name: "ap-south-1", code: "aps1" },
    { name: "us-east-1", code: "use1" },
    { name: "eu-west-1", code: "euw1" },
  ],
  gcp: [
    { name: "asia-south1", code: "as1" },
    { name: "us-central1", code: "usc1" },
    { name: "europe-west1", code: "ew1" },
  ],
};

const HelpRow = ({ label, value }) => (
  <div className="flex items-center text-sm text-gray-500 gap-2">
    <span className="inline-block w-20 text-gray-400">{label}</span>
    <code className="px-2 py-0.5 bg-gray-100 rounded border border-gray-200">{value}</code>
  </div>
);

function sanitizePart(part) {
  if (!part) return "";
  // lower, replace spaces/underscores with '-', drop invalid chars except '-'
  let p = String(part).toLowerCase();
  p = p.replace(/[\s_]+/g, "-");
  p = p.replace(/[^a-z0-9-]/g, "");
  p = p.replace(/-+/g, "-");
  p = p.replace(/^-|-$/g, "");
  return p;
}

function smartTrimBySegments(segments, delimiter, maxLen) {
  // Try to keep segment boundaries while trimming to maxLen.
  // Strategy: trim optional segments first (component, tier), then shorten workload, then org; finally hard cut end.
  const idx = {
    org: 0,
    workload: 1,
    env: 2,
    region: 3,
    type: 4,
    tier: 5,
    component: 6,
    seq: 7,
  };

  const minLens = [2, 3, 3, 2, 2, 0, 0, 2];

  const joinLen = segs => segs.filter(Boolean).join(delimiter).length;
  let segs = [...segments];

  const reduceTo = (i, min) => {
    if (!segs[i]) return;
    if (segs[i].length > min) segs[i] = segs[i].slice(0, Math.max(min, segs[i].length - 1));
  };

  const optionalOrder = [idx.component, idx.tier];

  while (joinLen(segs) > maxLen) {
    // Drop optional segments entirely if present
    let changed = false;
    for (const i of optionalOrder) {
      if (segs[i]) {
        segs[i] = segs[i].slice(0, Math.max(0, segs[i].length - 1));
        if (segs[i].length === 0) segs[i] = "";
        changed = true;
        if (joinLen(segs) <= maxLen) return segs;
      }
    }

    // Then shorten workload, region, org in that order
    for (const i of [idx.workload, idx.region, idx.org]) {
      const min = minLens[i];
      const before = segs[i];
      reduceTo(i, min);
      if (segs[i] !== before) {
        changed = true;
        if (joinLen(segs) <= maxLen) return segs;
      }
    }

    // If nothing changed, hard cut from the end of the full string
    if (!changed) {
      const full = segs.filter(Boolean).join(delimiter).slice(0, maxLen);
      return full.split(delimiter);
    }
  }
  return segs;
}

export default function NamingGenerator() {
  const [org, setOrg] = useState("bfl");
  const [workload, setWorkload] = useState("pay");
  const [env, setEnv] = useState("prd");
  const [provider, setProvider] = useState("azure");
  const [region, setRegion] = useState("cin");
  const [type, setType] = useState("vnet");
  const [tier, setTier] = useState("");
  const [component, setComponent] = useState("");
  const [seq, setSeq] = useState("01");
  const [delimiter, setDelimiter] = useState("-");
  const [maxLen, setMaxLen] = useState(60);
  const [autoTrim, setAutoTrim] = useState(true);

  const segments = useMemo(() => {
    const parts = [
      sanitizePart(org),
      sanitizePart(workload),
      sanitizePart(env),
      sanitizePart(region),
      sanitizePart(type),
      sanitizePart(tier),
      sanitizePart(component),
      sanitizePart(seq),
    ];
    // Remove empty optional parts to avoid consecutive delimiters
    return parts.map(p => p || "");
  }, [org, workload, env, region, type, tier, component, seq]);

  const name = useMemo(() => {
    let segs = [...segments];

    // ensure seq is two digits if numeric-like
    if (/^\d{1,2}$/.test(segs[7])) {
      segs[7] = segs[7].padStart(2, "0");
    }

    // collapse empties (for pretty join), but keep positions for smart trim
    let pretty = segs.filter(Boolean).join(delimiter);
    pretty = pretty.replace(new RegExp(`${delimiter}+`, "g"), delimiter).replace(new RegExp(`^${delimiter}|${delimiter}$`, "g"), "");

    if (autoTrim && pretty.length > maxLen) {
      const trimmedSegs = smartTrimBySegments(segs, delimiter, maxLen);
      pretty = trimmedSegs.filter(Boolean).join(delimiter).slice(0, maxLen);
    } else if (pretty.length > maxLen) {
      pretty = pretty.slice(0, maxLen);
    }

    return pretty;
  }, [segments, delimiter, maxLen, autoTrim]);

  const overBy = Math.max(0, name.length - maxLen);

  const copy = async () => {
    try {
      await navigator.clipboard.writeText(name);
    } catch (e) {
      console.error("Clipboard copy failed", e);
    }
  };

  return (
    <div className="min-h-screen w-full bg-gradient-to-b from-white to-gray-50 text-gray-900">
      <div className="mx-auto max-w-5xl px-6 py-10">
        <header className="mb-8">
          <h1 className="text-3xl md:text-4xl font-semibold tracking-tight">BFL Naming Generator</h1>
          <p className="text-gray-600 mt-2">Generate consistent names for cloud/network components using the pattern <code className="px-1 bg-gray-100 rounded">org-workload-env-region-type-tier?-component?-seq?</code></p>
        </header>

        <div className="grid md:grid-cols-3 gap-6">
          {/* Left column: form */}
          <section className="md:col-span-2">
            <div className="grid sm:grid-cols-2 gap-4 bg-white p-5 rounded-2xl shadow-sm border">
              <div>
                <label className="block text-sm mb-1">Provider</label>
                <select className="w-full border rounded-xl px-3 py-2" value={provider} onChange={(e) => {
                  const next = e.target.value;
                  setProvider(next);
                  setType(RESOURCE_TYPES[next][0]);
                  // region hint switch but keep user value
                }}>
                  {PROVIDERS.map(p => <option key={p} value={p}>{p.toUpperCase()}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm mb-1">Resource type</label>
                <select className="w-full border rounded-xl px-3 py-2" value={type} onChange={e => setType(e.target.value)}>
                  {RESOURCE_TYPES[provider].map(rt => <option key={rt} value={rt}>{rt}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm mb-1">Org</label>
                <input className="w-full border rounded-xl px-3 py-2" value={org} onChange={e => setOrg(e.target.value)} placeholder="bfl" />
              </div>

              <div>
                <label className="block text-sm mb-1">Workload</label>
                <input className="w-full border rounded-xl px-3 py-2" value={workload} onChange={e => setWorkload(e.target.value)} placeholder="pay, crm, core" />
              </div>

              <div>
                <label className="block text-sm mb-1">Environment</label>
                <select className="w-full border rounded-xl px-3 py-2" value={env} onChange={e => setEnv(e.target.value)}>
                  {ENV_OPTIONS.map(eo => <option key={eo} value={eo}>{eo}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm mb-1">Region (short code)</label>
                <input className="w-full border rounded-xl px-3 py-2" value={region} onChange={e => setRegion(e.target.value)} placeholder={provider === "azure" ? "cin" : provider === "aws" ? "aps1" : "as1"} />
                <div className="flex flex-wrap gap-2 mt-1 text-xs text-gray-500">
                  {(REGION_HINTS[provider] || []).map(h => (
                    <button key={h.code} className="px-2 py-0.5 rounded-full bg-gray-100 hover:bg-gray-200" onClick={(ev) => {ev.preventDefault(); setRegion(h.code);}} title={h.name}>{h.code}</button>
                  ))}
                </div>
              </div>

              <div>
                <label className="block text-sm mb-1">Tier (optional)</label>
                <select className="w-full border rounded-xl px-3 py-2" value={tier} onChange={e => setTier(e.target.value)}>
                  {TIER_OPTIONS.map(t => <option key={t || "none"} value={t}>{t || "(none)"}</option>)}
                </select>
              </div>

              <div>
                <label className="block text-sm mb-1">Component (optional)</label>
                <input className="w-full border rounded-xl px-3 py-2" value={component} onChange={e => setComponent(e.target.value)} placeholder="ingress, core, hub, spoke" />
              </div>

              <div>
                <label className="block text-sm mb-1">Sequence</label>
                <input className="w-full border rounded-xl px-3 py-2" value={seq} onChange={e => setSeq(e.target.value)} placeholder="01" />
              </div>

              <div>
                <label className="block text-sm mb-1">Delimiter</label>
                <input className="w-full border rounded-xl px-3 py-2" value={delimiter} onChange={e => setDelimiter(e.target.value || "-" )} maxLength={1} />
              </div>

              <div>
                <label className="block text-sm mb-1">Max length</label>
                <input type="number" className="w-full border rounded-xl px-3 py-2" value={maxLen} onChange={e => setMaxLen(Number(e.target.value) || 1)} min={10} max={120} />
              </div>

              <div className="col-span-full flex items-center gap-3 mt-1">
                <input id="autotrim" type="checkbox" checked={autoTrim} onChange={e => setAutoTrim(e.target.checked)} />
                <label htmlFor="autotrim" className="text-sm">Smart trim to fit max length</label>
              </div>
            </div>
          </section>

          {/* Right column: preview */}
          <aside className="md:col-span-1">
            <div className="bg-white p-5 rounded-2xl shadow-sm border sticky top-6">
              <h2 className="font-medium mb-3">Preview</h2>
              <div className="rounded-xl border bg-gray-50 p-4">
                <div className="text-xs uppercase text-gray-500 tracking-wide">Generated name</div>
                <div className="mt-2 font-mono break-all text-sm md:text-base">{name || "(start typing...)"}</div>
                <div className="mt-2 flex items-center justify-between text-xs text-gray-500">
                  <span>Length: <span className={name.length > maxLen ? "text-red-600" : ""}>{name.length}</span> / {maxLen}</span>
                  {overBy > 0 && <span className="text-red-600">Over by {overBy}</span>}
                </div>
                <div className="mt-3 flex gap-2">
                  <button className="px-3 py-2 rounded-lg border hover:bg-gray-100" onClick={copy}>Copy</button>
                  <button className="px-3 py-2 rounded-lg border hover:bg-gray-100" onClick={() => {
                    setOrg("bfl"); setWorkload("pay"); setEnv("prd"); setProvider("azure"); setRegion("cin"); setType("vnet"); setTier(""); setComponent(""); setSeq("01"); setDelimiter("-"); setMaxLen(60); setAutoTrim(true);
                  }}>Reset</button>
                </div>
              </div>

              <div className="mt-5 space-y-2">
                <h3 className="text-sm font-medium text-gray-700">Pattern</h3>
                <HelpRow label="Order" value="org-workload-env-region-type-tier?-component?-seq?" />
                <HelpRow label="Case" value="lowercase" />
                <HelpRow label="Chars" value="a-z 0-9 - (hyphen)" />
                <HelpRow label="Seq" value="01..99 (padded)" />
                <HelpRow label="Default max" value="60" />
              </div>
            </div>
          </aside>
        </div>

        <footer className="mt-10 text-xs text-gray-500">
          <p>
            Tip: Use region short codes like <code className="px-1 bg-gray-100 rounded">cin</code> (Azure Central India), <code className="px-1 bg-gray-100 rounded">aps1</code> (AWS ap-south-1), or <code className="px-1 bg-gray-100 rounded">as1</code> (GCP asia-south1).
          </p>
        </footer>
      </div>
    </div>
  );
}
